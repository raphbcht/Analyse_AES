<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Analyse AES - Formulaire complet</title>

  <!-- SurveyJS jQuery -->
  <script src="https://unpkg.com/jquery@3.7.1/dist/jquery.min.js"></script>
  <script src="https://unpkg.com/survey-jquery@1.9.131/survey.jquery.min.js"></script>
  <link href="https://unpkg.com/survey-core@1.9.131/defaultV2.min.css" rel="stylesheet"/>

  <style>
    body { font-family: Arial, sans-serif; margin: 30px; }
    #surveyContainer { max-width: 800px; margin: auto; }
    #result { margin-top: 20px; padding: 15px; border: 1px solid #ccc; background: #f9f9f9; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>Analyse de recevabilité AES</h1>
  <div id="surveyContainer"></div>
  <div id="result"></div>

  <script>
    // === JSON complet du formulaire AES ===
    const surveyJSON = {
      title: "Analyse de recevabilité AES",
      pages: [
        {
          name: "etatcivil",
          elements: [
            { type: "dropdown", name: "civil_title", title: "Civilité", isRequired: true, choices: ["Monsieur","Madame"] },
            { type: "text", name: "last_name", title: "Nom", isRequired: true },
            { type: "text", name: "first_name", title: "Prénom", isRequired: true },
            { type: "text", name: "birth_name", title: "Nom d’épouse (si applicable)" },
            { type: "text", name: "birth_date", title: "Date de naissance (AAAA-MM-JJ)", inputType:"date", isRequired: true },
            { type: "text", name: "birth_country", title: "Pays de naissance", isRequired: true },
            { type: "text", name: "nationality", title: "Nationalité", isRequired: true },
            { type: "text", name: "residence_commune", title: "Commune de résidence", isRequired: true },
            { type: "text", name: "residence_postcode", title: "Code postal", isRequired: true }
          ]
        },
        {
          name: "entreefrance",
          elements: [
            { type: "text", name: "entry_date", title: "Date d’entrée en France", inputType:"date", isRequired: true },
            { type: "dropdown", name: "entry_visa", title: "Statut d’entrée", isRequired: true, choices: ["Sans visa","Avec un visa D","Avec visa C"] },
            { type: "radiogroup", name: "asylum_application", title: "Demande d’asile en cours ?", isRequired: true, choices: ["Oui","Non"] },
            { type: "radiogroup", name: "oqtf", title: "Déjà une OQTF ?", isRequired: true, choices: ["Oui","Non"] },
            { type: "text", name: "oqtf_date", title: "Date OQTF", inputType:"date", visibleIf: "{oqtf} = 'Oui'" },
            { type: "radiogroup", name: "other_eu_residence_permit", title: "Titre de séjour délivré par un autre pays de l’UE ?", isRequired: true, choices: ["Oui","Non"] },
            { type: "text", name: "other_eu_country", title: "Quel pays ?", visibleIf: "{other_eu_residence_permit} = 'Oui'" },
            { type: "text", name: "other_eu_permit_expiry", title: "Date d’expiration du titre (AAAA-MM-JJ)", inputType:"date", visibleIf: "{other_eu_residence_permit} = 'Oui'" }
          ]
        },
        {
          name: "famille",
          elements: [
            { type: "dropdown", name: "marital_status", title: "Situation familiale", isRequired: true,
              choices: ["Célibataire","Concubin(e)","Pacsé(e)","Marié(e)","Veuf/Veuve","Divorcé(e)","Séparé(e)"] },
            { type: "text", name: "marriage_date", title: "Date mariage/PACS/concubinage", inputType:"date",
              visibleIf: "{marital_status} = 'Marié(e)' or {marital_status} = 'Pacsé(e)' or {marital_status} = 'Concubin(e)'" },
            { type: "text", name: "cohabitation_since", title: "Date début de vie commune", inputType:"date",
              visibleIf: "{marital_status} = 'Marié(e)' or {marital_status} = 'Pacsé(e)' or {marital_status} = 'Concubin(e)'" }
          ]
        },
        {
          name: "enfants",
          elements: [
            { type: "paneldynamic", name: "children", title: "Enfants", templateElements: [
              { type: "text", name: "child_name", title: "Nom", isRequired: true },
              { type: "text", name: "child_birthdate", title: "Date de naissance", inputType:"date", isRequired: true },
              { type: "text", name: "child_birth_country", title: "Pays de naissance", isRequired: true },
              { type: "text", name: "child_nationality", title: "Nationalité", isRequired: true },
              { type: "radiogroup", name: "child_schooling", title: "Scolarisé en France ?", choices:["Oui","Non"], isRequired:true },
              { type: "radiogroup", name: "child_schooling_3years", title: "Scolarisé depuis ≥ 3 ans ?", choices:["Oui","Non"],
                visibleIf:"{panel.child_schooling} = 'Oui'" }
            ],
            panelAddText:"Ajouter un enfant", panelRemoveText:"Supprimer", minPanelCount:0, maxPanelCount:10 }
          ]
        },
        {
          name: "travail",
          elements: [
            { type: "radiogroup", name: "has_contract", title: "Contrat de travail en cours ?", isRequired: true, choices:["Oui","Non"] },
            { type: "dropdown", name: "contract_type", title: "Type de contrat", visibleIf:"{has_contract} = 'Oui'", choices:["CDI","CDD","Intérim","Autre"] },
            { type: "text", name: "paye_slips_count_3years", title: "Nombre de fiches de paie sur 3 ans (≥18h/semaine)", inputType:"number", visibleIf:"{has_contract} = 'Oui'" },
            { type: "radiogroup", name: "employer_support", title: "Employeur prêt à aider ?", choices:["Oui","Non","Ne sais pas"], visibleIf:"{has_contract} = 'Oui'" }
          ]
        },
        {
          name: "declaration",
          elements: [
            { type: "checkbox", name: "honesty_declaration", title: "Je certifie l’exactitude des infos", isRequired:true, choices:["Je confirme"] },
            { type: "checkbox", name: "terms_accept", title: "J’accepte les CGV et la politique de confidentialité", isRequired:true, choices:["J’accepte"] }
          ]
        }
      ]
    };

    // === Création et affichage du formulaire ===
    $("#surveyContainer").Survey({
      model: new Survey.Model(surveyJSON),
      onComplete: function (sender) {
        const data = sender.data;
        let score = 0;

        // Scoring (simplifié, à étendre)
        if (data.oqtf === "Oui") score -= 100;
        if (data.asylum_application === "Oui") score -= 20;
        if (data.entry_visa === "Avec un visa D") score += 5;
        if (data.other_eu_residence_permit === "Oui") score += 15;
        if (data.children) {
          data.children.forEach(child => {
            if (child.child_schooling_3years === "Oui") score += 30;
          });
        }
        if (data.marital_status && (data.marital_status === "Marié(e)" || data.marital_status === "Pacsé(e)" || data.marital_status === "Concubin(e)")) {
          score += 20;
        }
        if (data.has_contract === "Oui" && data.contract_type === "CDI") score += 25;
        if (data.paye_slips_count_3years >= 36) score += 30;

        let conclusion = "";
        if (score >= 30) conclusion = "✅ Recevable probable";
        else if (score <= -30) conclusion = "❌ Irecevable probable";
        else conclusion = "⚖️ Cas borderline (examen manuel recommandé)";

        document.getElementById("result").innerHTML =
          "<h3>Résultat</h3>" +
          "<p><b>Score :</b> " + score + "</p>" +
          "<p><b>Conclusion :</b> " + conclusion + "</p>" +
          "<h4>Réponses</h4><pre>" + JSON.stringify(data, null, 2) + "</pre>";
      }
    });
  </script>
</body>
</html>
